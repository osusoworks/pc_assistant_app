name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, 3.12]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8 black bandit safety

    - name: Code formatting check
      run: |
        black --check --diff .

    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Security scan with bandit
      run: |
        bandit -r . -f json -o bandit-report.json || true

    - name: Safety check for dependencies
      run: |
        safety check --json --output safety-report.json || true

    - name: Import tests
      run: |
        python -c "from simple_library import SimpleLibrary; print('âœ… SimpleLibrary import OK')"
        python -c "from main_controller_simple import SimpleMainController; print('âœ… MainController import OK')"
        python -c "from ui_module_simple import SimpleUI; print('âœ… UI import OK')"

    - name: Unit tests
      run: |
        # Create basic test structure if not exists
        mkdir -p tests
        if [ ! -f tests/test_basic.py ]; then
          cat > tests/test_basic.py << 'EOF'
        import unittest
        import sys
        import os
        sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

        class TestBasicImports(unittest.TestCase):
            def test_simple_library_import(self):
                from simple_library import SimpleLibrary
                lib = SimpleLibrary()
                self.assertIsNotNone(lib)
            
            def test_main_controller_import(self):
                from main_controller_simple import SimpleMainController
                self.assertIsNotNone(SimpleMainController)
            
            def test_ui_module_import(self):
                from ui_module_simple import SimpleUI
                self.assertIsNotNone(SimpleUI)

        if __name__ == '__main__':
            unittest.main()
        EOF
        fi
        python -m pytest tests/ -v

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          bandit-report.json
          safety-report.json

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Create distribution package
      run: |
        # Create a clean distribution
        mkdir -p dist
        tar -czf dist/senpai-pc-assistant-${{ github.sha }}.tar.gz \
          --exclude='.git*' \
          --exclude='dist' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          .

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: distribution-package
        path: dist/

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README exists
      run: |
        if [ ! -f README.md ]; then
          echo "âŒ README.md not found"
          exit 1
        fi
        echo "âœ… README.md found"

    - name: Check documentation completeness
      run: |
        # Check for required sections in README
        required_sections=("ç‰¹å¾´" "ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ" "ä½¿ç”¨æ–¹æ³•" "ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³")
        for section in "${required_sections[@]}"; do
          if ! grep -q "$section" README.md; then
            echo "âŒ Missing section: $section"
            exit 1
          fi
        done
        echo "âœ… All required sections found"

    - name: Validate requirements.txt
      run: |
        if [ ! -f requirements.txt ]; then
          echo "âŒ requirements.txt not found"
          exit 1
        fi
        echo "âœ… requirements.txt found"
        
        # Check for common dependencies
        required_deps=("openai" "pillow")
        for dep in "${required_deps[@]}"; do
          if ! grep -q "$dep" requirements.txt; then
            echo "âš ï¸ Missing dependency: $dep"
          fi
        done

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, build, security, documentation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: distribution-package
        path: dist/

    - name: Generate release notes
      id: release_notes
      run: |
        # Generate automatic release notes
        echo "## ğŸš€ What's New" > release_notes.md
        echo "" >> release_notes.md
        echo "### Changes in this release:" >> release_notes.md
        git log --oneline --since="1 week ago" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ğŸ“¦ Installation" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "tar -xzf senpai-pc-assistant-*.tar.gz" >> release_notes.md
        echo "cd pc_assistant_app" >> release_notes.md
        echo "pip install -r requirements.txt" >> release_notes.md
        echo "python run_simple_clean.py" >> release_notes.md
        echo "\`\`\`" >> release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/*
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [test, build, security, documentation]
    if: always()

    steps:
    - name: Notify success
      if: ${{ needs.test.result == 'success' && needs.build.result == 'success' }}
      run: |
        echo "âœ… All checks passed successfully!"
        echo "ğŸ‰ SENPAI is ready for deployment!"

    - name: Notify failure
      if: ${{ needs.test.result == 'failure' || needs.build.result == 'failure' }}
      run: |
        echo "âŒ Some checks failed"
        echo "ğŸ”§ Please review the failed jobs and fix the issues"
