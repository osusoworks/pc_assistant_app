# SENPAI シンプルライブラリ機能 設計仕様

## 🎯 設計方針

### 最小限・安全第一
- **既存コードの変更を最小限に抑制**
- **新機能でエラーが発生しても既存機能に影響しない**
- **シンプルな実装で確実な動作**
- **段階的な機能追加**

## 📋 機能仕様

### 1. 基本ライブラリ機能

#### 1.1 ライブラリ保存
- **トリガー**: AI回答後に「⭐ お気に入り」ボタンを追加
- **保存内容**: 
  - 質問テキスト
  - AI回答テキスト
  - 作成日時
  - 簡単なタグ（手動入力）
- **保存場所**: `~/SENPAI/favorites/` ディレクトリ
- **ファイル形式**: JSON形式（1ファイル1お気に入り）

#### 1.2 ライブラリ参照
- **トリガー**: 「📚 お気に入り」ボタンを追加
- **表示方法**: 新しいウィンドウで一覧表示
- **機能**: 
  - 保存済みお気に入りの一覧表示
  - 質問・回答の表示
  - 削除機能

### 2. ファイル構造

```
~/SENPAI/
├── favorites/
│   ├── favorite_20231029_001.json
│   ├── favorite_20231029_002.json
│   └── ...
└── favorites_index.json
```

### 3. データ構造

#### 3.1 お気に入りファイル (favorite_xxx.json)
```json
{
  "id": "favorite_20231029_001",
  "question": "この青いボタンをクリックしたいです",
  "answer": "画面上の青いボタンをクリックするには...",
  "tag": "ボタンクリック",
  "created_at": "2023-10-29T10:30:00",
  "screenshot_path": "/path/to/screenshot.png"
}
```

#### 3.2 インデックスファイル (favorites_index.json)
```json
{
  "favorites": [
    {
      "id": "favorite_20231029_001",
      "question": "この青いボタンをクリックしたいです",
      "tag": "ボタンクリック",
      "created_at": "2023-10-29T10:30:00"
    }
  ],
  "last_updated": "2023-10-29T10:30:00"
}
```

## 🔧 実装方針

### 1. モジュール構成

#### 1.1 新規追加ファイル
- `simple_library.py` - ライブラリ管理クラス
- `library_ui.py` - ライブラリUI（お気に入り一覧ウィンドウ）

#### 1.2 既存ファイル変更
- `ui_module_hide_aware.py` - ボタン追加のみ
- `main_controller_final_ui_hide.py` - コールバック追加のみ

### 2. 実装ステップ

#### Step 1: ライブラリ管理クラス
```python
class SimpleLibrary:
    def save_favorite(self, question, answer, tag="")
    def get_favorites_list(self)
    def delete_favorite(self, favorite_id)
    def get_favorite(self, favorite_id)
```

#### Step 2: UI拡張
- 既存UIに「⭐ お気に入り」ボタン追加
- 既存UIに「📚 お気に入り一覧」ボタン追加

#### Step 3: ライブラリUIウィンドウ
- シンプルなtkinterウィンドウ
- お気に入り一覧表示
- 削除機能

### 3. エラーハンドリング

#### 3.1 安全性確保
```python
try:
    # ライブラリ機能
    library_operation()
except Exception as e:
    print(f"ライブラリ機能エラー: {e}")
    # エラーでも既存機能は継続
```

#### 3.2 フォールバック
- ライブラリ機能でエラーが発生しても既存機能は正常動作
- ファイル操作エラー時は適切なメッセージ表示

## 🎨 UI設計

### 1. メインUI拡張

#### 既存ボタンの下に追加:
```
[🚀 質問する（UI自動非表示）]
[📷 手動スクリーンショット（UI非表示）]
[⭐ お気に入りに保存]        ← 新規追加
[📚 お気に入り一覧]         ← 新規追加
[❌ 終了]
```

### 2. お気に入り一覧ウィンドウ

```
┌─ お気に入り一覧 ─────────────────┐
│ [検索] [_______________]         │
│                                  │
│ ○ ボタンクリック (10/29 10:30)   │
│   この青いボタンをクリック...     │
│   [表示] [削除]                  │
│                                  │
│ ○ ファイル保存 (10/29 11:00)     │
│   ファイルを保存する方法...       │
│   [表示] [削除]                  │
│                                  │
│ [閉じる]                         │
└──────────────────────────────────┘
```

## 🔄 動作フロー

### 1. お気に入り保存フロー
1. ユーザーが質問してAI回答を取得
2. 「⭐ お気に入りに保存」ボタンをクリック
3. タグ入力ダイアログ表示
4. ファイルに保存
5. 「保存しました」メッセージ表示

### 2. お気に入り参照フロー
1. 「📚 お気に入り一覧」ボタンをクリック
2. 新しいウィンドウでお気に入り一覧表示
3. 項目をクリックで詳細表示
4. 削除ボタンで削除確認後削除

## 🧪 テスト計画

### 1. 基本機能テスト
- お気に入り保存機能
- お気に入り一覧表示機能
- お気に入り削除機能

### 2. エラーテスト
- ファイルアクセスエラー
- JSON解析エラー
- UI操作エラー

### 3. 統合テスト
- 既存機能との共存
- エラー時の既存機能への影響なし

## 📊 成功基準

### 1. 機能要件
- ✅ お気に入り保存が正常動作
- ✅ お気に入り一覧表示が正常動作
- ✅ お気に入り削除が正常動作

### 2. 安全性要件
- ✅ ライブラリ機能でエラーが発生しても既存機能は正常動作
- ✅ ファイル操作エラーでアプリケーションが終了しない
- ✅ UI操作エラーでメインUIが影響を受けない

### 3. ユーザビリティ要件
- ✅ 直感的なUI操作
- ✅ 適切なエラーメッセージ表示
- ✅ レスポンシブな操作感
